<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Safety System - Live View</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif; background-color: #1a1a1a; color: #e0e0e0; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1280px; }
        h1 { text-align: center; color: #4CAF50; }
        .main-content { display: flex; gap: 20px; }
        .video-container { flex-grow: 1; border: 1px solid #444; }
        .video-container img { width: 100%; height: auto; display: block; }
        .controls-and-logs { width: 320px; display: flex; flex-direction: column; gap: 20px; }
        .controls, .logs { background-color: #2c2c2c; padding: 15px; border-radius: 8px; }
        h2 { margin-top: 0; border-bottom: 1px solid #4CAF50; padding-bottom: 10px; }
        button { background-color: #4CAF50; color: white; border: none; padding: 10px 15px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 5px; width: 100%; }
        button:hover { background-color: #45a049; }
        #log-container { height: 400px; overflow-y: auto; background-color: #1a1a1a; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; }
        .log-message { padding: 5px; border-bottom: 1px solid #333; }
        .log-message.critical { color: #ff6b6b; }
        .log-message.high { color: #ffa07a; }
        .log-message.medium { color: #ffd700; }
        .log-message.safe { color: #90ee90; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Smart Safety System - Live Dashboard</h1>
        <div class="main-content">
            <div class="video-container">
                <h2>Live Feed</h2>
                <img src="http://localhost:8000/api/video_feed" alt="Live video feed from the safety system.">
            </div>
            <div class="controls-and-logs">
                <div class="controls">
                    <h2>Controls</h2>
                    <button id="toggle-mode-btn">Toggle Conveyor Mode</button>
                </div>
                <div class="logs">
                    <h2>Real-time Alerts</h2>
                    <div id="log-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const logContainer = document.getElementById('log-container');
        const toggleButton = document.getElementById('toggle-mode-btn');

        // --- WebSocket Connection ---
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${wsProtocol}://localhost:8000/ws/alerts`);

        ws.onopen = function(event) {
            console.log("WebSocket connection established.");
            addLog("Connected to server for real-time alerts.", "safe");
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log("Message from server: ", data);
            const riskLevel = data.risk_level || 'medium';
            addLog(JSON.stringify(data, null, 2), riskLevel);
        };

        ws.onclose = function(event) {
            console.error("WebSocket connection closed.");
            addLog("Connection to server lost. Please refresh.", "critical");
        };

        ws.onerror = function(error) {
            console.error("WebSocket error: ", error);
            addLog("An error occurred with the real-time alert system.", "critical");
        };

        function addLog(message, level) {
            const logElement = document.createElement('div');
            logElement.className = `log-message ${level}`;
            logElement.textContent = message;
            logContainer.appendChild(logElement);
            // Scroll to the bottom
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // --- Control Button --- 
        toggleButton.addEventListener('click', async () => {
            try {
                const response = await fetch('http://localhost:8000/api/toggle_mode', { method: 'POST' });
                const data = await response.json();
                console.log("Toggled mode:", data);
                const mode = data.conveyor_operating ? 'OPERATING' : 'STOPPED';
                addLog(`Conveyor mode changed to: ${mode}`, 'safe');
            } catch (error) {
                console.error("Failed to toggle mode:", error);
                addLog("Error trying to change conveyor mode.", "critical");
            }
        });

    </script>
</body>
</html>